#!/usr/bin/env bash

print_help() {
  echo "spoon - ssh into ec2 instances easily"
  echo "usage: spoon identifier"
}

has_short_flag() {
	flag="$1"
	shift
	args="$@"
	for arg in $args; do
		if [ "${arg:0:1}" = - ] && [ "${arg:1:1}" != - ] && [[ "$arg" =~ "$flag" ]]; then
			return 0
		fi
	done
	return 1
}

has_long_flag() {
	flag="$1"
	shift
	args="$@"
	for arg in $args; do
		if [ "${arg:0:2}" = -- ] && [[ "$arg" == --"$flag" ]]; then
			return 0
		fi
	done
	return 1
}

################################################
################################################
################################################

if [[ $# -lt 1 ]]; then
	print_help
	exit 1
fi

if has_short_flag h "$@" || has_long_flag 'help' "$@"; then
  print_help
  exit 0
fi

specifier="${*: -1}"

aws ec2 describe-instances --filters "Name=tag:Name,Values=*$specifier*" | jq '.Reservations | map(.Instances[0] | (.Tags | map(select(.Key == "Name").Value))[0] + "__" + .InstanceId + "__" + .PublicIpAddress + "__(" + .State.Name + ")")'
